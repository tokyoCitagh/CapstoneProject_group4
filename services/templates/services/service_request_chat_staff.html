{% extends "base_portal.html" %}
{% load static %}
{% load service_utils %} {# Assumed custom tag import #}

{% block title %}Chat: Request #{{ service_request.id }} (Staff Portal){% endblock %}

{% block main_content %} 
<style>
    /* Custom styles for the chat interface */
    .chat-container {
        border: 1px solid #e0e0e0;
        padding: 20px;
        height: 500px; /* Increased height for better interaction */
        overflow-y: auto; /* Scrollable chat history */
        background-color: #f7f9fc; /* Very light background */
        border-radius: 10px;
        display: flex; /* Flexbox for stacking messages */
        flex-direction: column;
    }
    .chat-message-wrapper {
        display: flex;
        width: 100%;
        margin-bottom: 12px;
    }
    .chat-message {
        padding: 12px 16px;
        border-radius: 20px; /* Rounded corners for bubble effect */
        max-width: 75%; /* Limit bubble width */
        word-wrap: break-word; 
        font-size: 0.95em;
        line-height: 1.4;
        position: relative;
    }

    /* STAFF Messages (YOU) - Right side, Blue/Indigo color */
    .staff-message-wrapper {
        justify-content: flex-end; /* Push to the right */
    }
    .staff-message {
        background-color: #4f46e5; /* Indigo/Blue for Staff */
        color: white; /* White text for contrast */
        border-bottom-right-radius: 4px; /* Slightly less round on the bottom-right for the sender */
    }
    
    /* CUSTOMER Messages - Left side, Neutral color */
    .customer-message-wrapper {
        justify-content: flex-start; /* Keep on the left */
    }
    .customer-message {
        background-color: #e5e7eb; /* Light Gray for Customer */
        color: #374151; /* Darker text */
        border-bottom-left-radius: 4px; /* Slightly less round on the bottom-left for the sender */
    }

    .chat-timestamp {
        display: block;
        font-size: 0.65em;
        margin-top: 5px;
        opacity: 0.7; /* Subtle timestamp */
        text-align: right;
    }
    .customer-message .chat-timestamp {
        text-align: left;
    }

    /* Style for the sender label */
    .chat-sender-label {
        font-weight: bold;
        font-size: 0.8em;
        margin-bottom: 3px;
    }
    .staff-message .chat-sender-label { color: #f3f4f6; } /* Light gray label on staff message */
    .customer-message .chat-sender-label { color: #4b5563; } /* Dark gray label on customer message */
</style>

<div class="max-w-4xl" style="margin: 0 auto; background-color: white; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 10px;">
    
    {# --- HEADER --- #}
    <h2 style="color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; font-size: 1.8em; font-weight: bold;">
        ‚öôÔ∏è Service Portal: Request #{{ service_request.id }}
    </h2>
    <p style="color: #007bff; font-size: 1.2em; margin-bottom: 15px;">{{ service_request.service_type }}</p>

    {# --- STAFF-ONLY STATUS UPDATE FORM --- #}
    <form method="post" style="margin-bottom: 20px; padding: 15px; border: 1px solid #c3e6cb; border-radius: 8px; background-color: #f7fff5;">
        {% csrf_token %}
        <h3 style="color: #155724; font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">Update Request Status:</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select name="new_status" required 
                    style="padding: 8px; border: 1px solid #198754; border-radius: 5px; flex-grow: 1;">
                <option value="" disabled selected>Change Status To...</option>
                {# Using status_choices context variable from view #}
                {% for key, value in STATUS_CHOICES %}
                    <option value="{{ key }}" {% if key == service_request.status %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
            <button type="submit" name="update_status" value="true" 
                    style="padding: 8px 15px; background-color: #198754; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s;">
                Apply Status
            </button>
        </div>
    </form>

    {# --- REQUEST DETAILS (Optional: Keep it less intrusive) --- #}
    <details style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #fafafa;">
        <summary style="font-weight: bold; cursor: pointer; color: #333;">Show Request Details</summary>
        <div style="padding-top: 10px; font-size: 0.9em; line-height: 1.6;">
            {# Use customer_name/contact_number from the request model directly #}
            <p><strong>Customer:</strong> {{ service_request.customer_name|default:"N/A" }} 
            {% if service_request.contact_number %}({{ service_request.contact_number }}){% elif service_request.contact_email %}({{ service_request.contact_email }}){% endif %}
            </p> 
            <p><strong>Current Status:</strong> <span style="font-weight: bold; color: {% if service_request.status == 'PENDING' %}red{% elif service_request.status == 'QUOTED' %}orange{% else %}green{% endif %};">
                {{ service_request.get_status_display }}
            </span></p>
            <p><strong>Initial Description:</strong> {{ service_request.description }}</p>
            {% for attachment in attachments %}
                <p><strong>Attachment {{ forloop.counter }}:</strong> 
                <a href="{{ attachment.file.url }}" target="_blank" style="color: #007bff; text-decoration: underline;">View File ({{ attachment.file.name|split:'/'|last }})</a></p>
            {% endfor %}
        </div>
    </details>

    {# --- CHAT HISTORY --- #}
    <h3 style="font-size: 1.5em; color: #555; margin-bottom: 15px;">üí¨ Chat History</h3>
    <div id="chat-history" class="chat-container">
        {% for message in messages %}
        <div class="chat-message-wrapper {% if message.sender == 'ADMIN' %}staff-message-wrapper{% else %}customer-message-wrapper{% endif %}">
            <div class="chat-message {% if message.sender == 'ADMIN' %}staff-message{% else %}customer-message{% endif %}">
                
                <span class="chat-sender-label">
                    {% if message.sender == 'ADMIN' %}Staff (You){% else %}Customer{% endif %}
                </span>
                
                <p style="margin: 0;">{{ message.message }}</p>
                
                <span class="chat-timestamp">
                    {{ message.timestamp|date:"M d, H:i" }}
                </span>
            </div>
        </div>
        {% empty %}
        <p style="text-align: center; color: #999; padding: 50px 0;">No messages yet. Start the conversation!</p>
        {% endfor %}
    </div>

    {# --- SEND RESPONSE FORM --- #}
    <h3 style="font-size: 1.5em; color: #555; margin-top: 20px; margin-bottom: 10px;">Send a Response</h3>
    <form method="post" style="display: flex; flex-direction: column; gap: 10px;">
        {% csrf_token %}
        <textarea name="message" rows="4" required placeholder="Type your quote, question, or update..."
                  style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; resize: vertical;"></textarea>
        
        <button type="submit" 
                style="padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.2s;">
            Send Message (as Staff)
        </button>
    </form>

    <p style="text-align: center; margin-top: 20px;">
        <a href="{% url 'portal:staff_requests_list' %}" style="color: #007bff; text-decoration: underline; transition: color 0.2s;">
            ‚Üê Back to All Service Requests
        </a>
    </p>
</div>

<script>
    // Scroll chat history to the bottom on page load
    document.addEventListener('DOMContentLoaded', () => {
        const chatContainer = document.getElementById('chat-history');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });
</script>

{% endblock main_content %}