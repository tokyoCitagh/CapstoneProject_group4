{% extends "store/base.html" %}
{% load static %}
{% load service_utils %}
{% block title %}Chat: Request #{{ service_request.id }}{% endblock %} 

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-xl border border-gray-200">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Service Request #{{ service_request.id }}</h2>
    <p class="text-xl text-indigo-600 mb-4">{{ service_request.service_type }}</p>

    <div class="grid grid-cols-2 gap-4 text-sm mb-6 pb-4 border-b">
        <div><strong>Customer:</strong> {{ service_request.customer.name|default:"N/A" }} ({{ service_request.customer.email|default:"N/A" }})</div>
        <div><strong>Status:</strong> <span class="font-bold 
            {% if service_request.status == 'PENDING' %}text-red-500{% elif service_request.status == 'QUOTED' %}text-yellow-600{% else %}text-green-600{% endif %}">
            {{ service_request.status }}
        </span></div>
        <div class="col-span-2"><strong>Initial Description:</strong> {{ service_request.description }}</div>
        {% for attachment in service_request.attachments.all %}
        <div class="col-span-2">
            <strong>Attachment {{ forloop.counter }}:</strong> 
            <a href="{{ attachment.file.url }}" target="_blank" class="text-indigo-500 hover:text-indigo-700 underline">View File ({{ attachment.file.name|split:'/'|last }})</a>
        </div>
        {% endfor %}
    </div>

    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Chat History</h3>
    <div id="chat-history" class="border border-gray-300 p-4 mb-6 max-h-96 overflow-y-auto bg-gray-50 rounded-lg">
        {% for message in messages %}
        <div class="mb-3 p-3 rounded-lg 
            {# Customer View: Customer messages (not ADMIN) go RIGHT, Staff messages (ADMIN) go LEFT #}
            {% if message.sender == 'ADMIN' %}bg-white border border-gray-200 mr-auto w-11/12{% else %}bg-indigo-100 border-r-4 border-indigo-500 ml-auto w-11/12{% endif %}">
            <small class="text-xs 
                {% if message.sender == 'ADMIN' %}text-gray-500{% else %}text-indigo-700{% endif %}">
                {{ message.timestamp|date:"M d, H:i" }} - 
                <strong class="font-bold">
                    {% if message.sender == 'ADMIN' %}Staff{% else %}Customer (You){% endif %}
                </strong>:
            </small>
            <p class="mt-1 text-gray-800 whitespace-pre-wrap">{{ message.message }}</p>
        </div>
        {% empty %}
        <p class="text-center text-gray-500 italic">No messages yet. Start the conversation!</p>
        {% endfor %}
    </div>

    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Send a Response</h3>
    <form method="post" class="space-y-4">
        {% csrf_token %}
        <textarea name="message_text" rows="4" required placeholder="Type your quote, question, or update..."
                  class="w-full border-2 border-gray-300 p-3 rounded-lg focus:border-indigo-500 focus:ring-indigo-500"></textarea>
        
        <button type="submit" 
                class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
            Send Message
        </button>
    </form>

    <p class="mt-6 text-center">
        <a href="{% url 'services:customer_requests_list' %}" class="text-indigo-600 hover:text-indigo-800 font-medium">
            ‚Üê Back to My Service Requests
        </a>
    </p>
</div>
{% endblock %}